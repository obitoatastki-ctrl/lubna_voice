<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>صفحة أعمالي - Lubna Voice</title>
<style>
body { font-family: Arial; background: #f0f4f8; padding: 20px; }
h1 { color: #1e3a8a; }
#gallery { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
.video-item { width: 300px; position: relative; }
video { width: 100%; height: auto; }
.filename { font-size: 0.9em; margin-top: 5px; color: #333; }
.delete-btn { position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; padding: 3px 6px; cursor: pointer; font-size: 0.8em; }
</style>
</head>
<body>
<h1>صفحة أعمالي</h1>

<input type="file" id="fileUpload" multiple accept="video/*,audio/*">
<button onclick="uploadFiles()">رفع الملفات</button>

<div id="gallery">
{% for v in videos %}
<div class="video-item" data-id="{{v[0]}}">
  <video controls>
    <source src="{{v[2]}}" type="video/mp4">
    المتصفح لا يدعم عرض الفيديو.
  </video>
  <div class="filename">{{v[1]}}</div>
  <button class="delete-btn" onclick="deleteVideo({{v[0]}}, this)">حذف</button>
</div>
{% endfor %}
</div>

<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<script>
const cloudName = '{{cloud_name}}';
const uploadPreset = '{{upload_preset}}';
const gallery = document.getElementById('gallery');

function uploadFiles() {
  const files = document.getElementById('fileUpload').files;
  if (!files.length) return alert("اختر ملفات للرفع");

  for (let file of files) {
    const widget = cloudinary.createUploadWidget({
      cloudName: cloudName,
      uploadPreset: uploadPreset,
      sources: ['local', 'camera'],
      multiple: false,
      maxFileSize: 1000000000
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        addVideoToGallery(result.info.secure_url, file.name);
      }
    });
    widget.open();
  }
}

function addVideoToGallery(url, name) {
  fetch('/add_video', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name, url})
  }).then(res => res.json()).then(data => {
    const div = document.createElement('div');
    div.classList.add('video-item');
    div.setAttribute('data-id', data.id);
    div.innerHTML = `
      <video controls>
        <source src="${url}" type="video/mp4">
      </video>
      <div class="filename">${name}</div>
      <button class="delete-btn" onclick="deleteVideo(${data.id}, this)">حذف</button>
    `;
    gallery.prepend(div);
  });
}

function deleteVideo(id, button) {
  fetch('/delete', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id})
  }).then(res => res.json()).then(data => {
    if (data.status === 'success') button.parentElement.remove();
  });
}
</script>
</body>
</html>
